<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 11 (filtered)">
<title>Advanced Cell Programming</title>
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"ＭＳ 明朝";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:"ＭＳ ゴシック";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:Century;
	panose-1:2 4 6 4 5 5 5 2 3 4;}
@font-face
	{font-family:"ＭＳ Ｐゴシック";
	panose-1:2 11 6 0 7 2 5 8 2 4;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"¥@ＭＳ ゴシック";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:"¥@ＭＳ Ｐゴシック";
	panose-1:2 11 6 0 7 2 5 8 2 4;}
@font-face
	{font-family:"¥@ＭＳ 明朝";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:"EHJAP H+ Helvetica";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"¥@EHJAP H+ Helvetica";}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:Century;}
h1
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:21.25pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-21.25pt;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:Arial;
	font-weight:bold;}
h2
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:49.6pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.0mm;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Arial;
	font-weight:normal;}
h3
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:70.9pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-10.0mm;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Arial;
	font-weight:normal;}
h4
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:99.2pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-35.4pt;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Century;
	font-weight:bold;}
h5
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:127.55pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-42.5pt;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Arial;
	font-weight:normal;}
h6
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:163.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-20.0mm;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Century;
	font-weight:bold;}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:191.35pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-63.8pt;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Century;}
p.MsoHeading8, li.MsoHeading8, div.MsoHeading8
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:219.7pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-70.9pt;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Century;}
p.MsoHeading9, li.MsoHeading9, div.MsoHeading9
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:255.1pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-85.0pt;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:Century;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:Century;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:10.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:Century;}
p.MsoCommentText, li.MsoCommentText, div.MsoCommentText
	{margin:0mm;
	margin-bottom:.0001pt;
	font-size:10.5pt;
	font-family:Century;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	layout-grid-mode:char;
	font-size:10.5pt;
	font-family:Century;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	layout-grid-mode:char;
	font-size:10.5pt;
	font-family:Century;}
p.MsoCaption, li.MsoCaption, div.MsoCaption
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:Century;
	font-weight:bold;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{margin-top:12.0pt;
	margin-right:0mm;
	margin-bottom:6.0pt;
	margin-left:0mm;
	text-align:center;
	font-size:16.0pt;
	font-family:Arial;}
p.MsoBodyText, li.MsoBodyText, div.MsoBodyText
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:Century;}
p.MsoBodyTextIndent, li.MsoBodyTextIndent, div.MsoBodyTextIndent
	{margin-top:0mm;
	margin-right:0mm;
	margin-bottom:0mm;
	margin-left:31.5pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:10.5pt;
	font-size:10.5pt;
	font-family:Arial;}
p.MsoSubtitle, li.MsoSubtitle, div.MsoSubtitle
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:12.0pt;
	font-family:Arial;}
p.MsoDate, li.MsoDate, div.MsoDate
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:Century;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p.MsoDocumentMap, li.MsoDocumentMap, div.MsoDocumentMap
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	background:navy;
	font-size:10.5pt;
	font-family:Arial;}
p
	{margin-right:0mm;
	margin-left:0mm;
	font-size:12.0pt;
	font-family:"ＭＳ Ｐゴシック";}
pre
	{margin:0mm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"ＭＳ ゴシック";}
p.MsoCommentSubject, li.MsoCommentSubject, div.MsoCommentSubject
	{margin:0mm;
	margin-bottom:.0001pt;
	font-size:10.5pt;
	font-family:Century;
	font-weight:bold;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{margin:0mm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:Arial;}
p.contentfont, li.contentfont, div.contentfont
	{margin-right:0mm;
	margin-left:0mm;
	line-height:15.0pt;
	font-size:9.0pt;
	font-family:Verdana;}
p.default, li.default, div.default
	{margin:0mm;
	margin-bottom:.0001pt;
	text-autospace:none;
	font-size:12.0pt;
	font-family:"Times New Roman";
	color:black;}
p.sp8266242, li.sp8266242, div.sp8266242
	{margin:0mm;
	margin-bottom:.0001pt;
	text-autospace:none;
	font-size:12.0pt;
	font-family:"EHJAP H+ Helvetica";}
p.sp8266260, li.sp8266260, div.sp8266260
	{margin:0mm;
	margin-bottom:.0001pt;
	text-autospace:none;
	font-size:12.0pt;
	font-family:"EHJAP H+ Helvetica";}
p.sp8266294, li.sp8266294, div.sp8266294
	{margin:0mm;
	margin-bottom:.0001pt;
	text-autospace:none;
	font-size:12.0pt;
	font-family:"EHJAP H+ Helvetica";}
span.sc8126981
	{font-family:"EHJAP H+ Helvetica";
	color:black;}
span.msoins0
	{color:teal;
	text-decoration:underline;}
span.msodel0
	{color:red;
	text-decoration:line-through;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:42.55pt 42.55pt 42.55pt 42.55pt;
	layout-grid:14.55pt;}
div.Section1
	{page:Section1;}
-->
</style>

</head>

<body lang=JA link=blue vlink=purple style='text-justify-trim:punctuation'>

<div class=Section1 style='layout-grid:14.55pt'>

<h1><a name="_Ref153876915"></a><a name="_Toc188185550"></a><span lang=EN-US>Chapter
4</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Advanced Cell Programming</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Now that the
basics of the Cell programming have been studied in the previous chapters,
let’s proceed further to learn about advanced functions of the Cell as well as
useful tips on the Cell programming techniques. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center'><span lang=EN-US>Table
4.1: Structure of Chapter 4</span></p>

<div align=center>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US>Section</span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US>Title</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US>Description</span></p>
  </td>
 </tr>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  border-top:none;background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Section 4.1 </span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Communication
  between PPE and SPE</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Describes
  the many communication functions the SPE offers such as mailboxes, signal
  notification registers, and stop and signal interrupts. </span></p>
  </td>
 </tr>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Section 4.2</span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Effective
  Utilization of DMA Transfer</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Provides
  in-depth information about DMA transfer, including precautions about the data
  to be transferred, and further additional DMA transfer commands offered by
  the MFC.</span></p>
  </td>
 </tr>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  border-top:none;background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Section 4.3</span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Representation
  of Data Shared between PPE and SPE</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Explicates the precautions about sharing
  data between the PPE and SPE programs that use different data models. </span></p>
  </td>
 </tr>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Section 4.4</span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Vector
  Data Alignment</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Explicates
  the precautions about the alignment of vector data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  border-top:none;background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Section 4.5</span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Scalar
  Operations on SPE</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#E6E6E6;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Explains
  the characteristics of the preferred slot, with focusing on the efficiency of
  scalar operations by the SPE. </span></p>
  </td>
 </tr>
 <tr>
  <td width=96 valign=top style='width:71.95pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><span lang=EN-US>Section 4.6</span></p>
  </td>
  <td width=245 valign=top style='width:183.4pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Embedded
  SPE Program</span></p>
  </td>
  <td width=295 valign=top style='width:220.95pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Focuses
  on the method of embedding SPE program images in an ELF executable file of
  the PPE program. </span></p>
  </td>
 </tr>
</table>

</div>

<span lang=EN-US style='font-size:10.5pt;font-family:Century'><br clear=all
style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Ref153206819"></a><a
name="_Toc188185551"></a><a name="_Toc177361266"></a><a name="_Ref171401557"></a><a
name="_Toc168979012"></a><span lang=EN-US>4.1</span><span lang=EN-US
style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Communication between PPE and SPE</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As described in
Chapter 3, the Cell-unique SPE makes use of the MFC to transfer data between itself
and another SPE or the PPE. The MFC incorporates a DMA controller to allow DMA
transfer delineated in Section 3.3.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Now then, let’s
take a look into some other means of communication offered by the MFC to
support the transactions between an SPE and its external world (other SPEs and
the PPE). Typical among them are the mailboxes and signal notification
registers. The Stop and Signal instruction of the SPE is also explained.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.1.1</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Mailboxes</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>While DMA
transfer allows transfer of up to 16K bytes of data between the main memory and
each SPE’s LS, mailboxes are designed for transfer of 32-bit data between the
PPE and the SPE. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoBodyText style='text-indent:10.5pt'><span lang=EN-US>To put it
another way, mailboxes are fit for transferring small data such as status
information and parameters. Structurally, mailboxes are FIFO* queues (serieses
of buffers for storing data). The MFC provides three types of mailbox queues,
each with a different behavior and data transfer direction as shown in Fig.
4.1.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:50.0pt;text-indent:-8.0pt'><span
lang=EN-US style='font-size:8.0pt'>* FIFO: An acronym for First In, First Out.
This expression describes the data access principle of a queue, where what
comes in first is handled first. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img width=491 height=344
src="CellProgrammingTutorial.files/image052.jpg" border=0></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref162880915"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.1:
Mailboxes</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>SPU Inbound Mailbox</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Used to send
data from the PPE to the SPE. This mailbox has space for storing up to four
32-bit messages at a time. If no message is found when the SPE program accessed
the queue, the SPE stalls until data is written by the PPE program.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>SPU Outbound Mailbox</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Used to pass
data from the SPE to the PPE. This mailbox has the capacity to accept only one
32-bit message. If the SPU outbound mailbox is full, writing of the next data
is suspended until the PPE reads the data from the queue.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>SPU Outbound Interrupt Mailbox</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Like the SPU
outbound mailbox, this is used to send data from the SPE to the PPE. When this
mailbox is written, however, an interrupt event is generated to notify the PPE
when to read the data. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>These mailboxes
can be accessed either from the SPE or PPE programs. The SPE program uses a
channel interface to access the mailboxes. The PPE program does this via
mailbox API functions offered by libspe2. Refer to the following documents for
more details. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Mailbox access from the SPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Section 19.6:
Mailboxes of the Cell Broadband Engine Programming Handbook.</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Mailbox access from the PPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Chapter 7: SPE
Mail Box Functions of the SPE Runtime Management Library Version 2.1.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.1.2</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Signal Notification Registers</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>SPU signal
notification registers (hereinafter abbreviated as SNRs) are 32-bit registers
used to send signals, such as control messages and events, to an SPE from other
SPEs or the PPE. There are two SNRs for each SPE. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The sending
processor (either PPE or SPE) writes the signal value in the form of 32-bit
data into the SNR of the receiving processor (one of other SPEs). When the
value is read by the receiving processor, all bits in the SNR are reset to
zero. If the SNR is empty when it is read, the receiving processor stops
execution until the signal is written.&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:14.15pt'><span lang=EN-US>Each bit of the
32-bit signal data can be assigned to the program's own specific meaning. By
doing so, the signal can notify the SPE of anything from the change of status
to the completion of processing. The SNRs can also be configured for overwrite
mode or logical OR mode. The overwrite mode is useful in a one-to-one signaling
environment, whereas the logical OR mode enables many-to-one signaling. Either
of these modes can be selected for each SNR, independently of the other.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Fig. 4.2 shows
the difference between the SNR’s two operating modes.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img width=547 height=355
src="CellProgrammingTutorial.files/image053.jpg" border=0></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref162880973"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.2: SPU
Signal Notification Modes</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>SNRs are similar
to the SPU inbound mailbox. A major difference between the two is that SNRs can
be used not only for data transfer between the PPE and SPE but also for that
between SPEs, whereas the mailbox is limited to use between the PPE and SPE
only. Capitalizing on the logical OR mode that allows many-to-one data
transfer, the SNRs also make barrier synchronization of multiple SPE programs
possible.</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><a name="pgfId=1018940"></a><span
lang=EN-US>The signal transmission method to the SNRs differs between the PPE
program and the SPE program. The PPE program sends the signal through a signal
API provided by libspe2. The SPE program uses a dedicated DMA transfer command
(SNDSIG) to send the signal to the destination SNR’s effective address mapped
on the effective address space. The SNR’s effective address can be obtained
through the API furnished by libspe2 to allow direct SPE access. As soon as the
signal is written in the SNR, it becomes possible for the receiving SPE to read
it out through the channel interface. For further information, refer to the
following documents. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Signal transmission from the PPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Descriptions
about the SPE SPU signal notification functions in Chapter 7: SPE MFC Problem
State Facilities of the SPE Runtime Management Library Version 2.1.</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Signal transmission from the SPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Section 19.7:
Signal Notification of the Cell Broadband Engine Programming Handbook.</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Signal reception by the SPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Section 19.7:
Signal Notification of the Cell Broadband Engine Programming Handbook.</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(4)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Access to the SNR’s effective address</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Chapter 8:
Direct SPE Access for Applications of the SPE Runtime Management Library
Version 2.1.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.1.3</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Stop and Signal Instruction</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The Stop and
Signal instruction temporarily halts or terminates the SPE program being
executed and the execution flow returns to the PPE program. Once this
instruction is executed by the SPE, an interrupt called the stop and signal
instruction trap is notified to the PPE, causing it to handle the request in
accordance with the received interrupt signal. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The Stop and
Signal instruction is used to enable a variety of processes &#8211; to return from
the SPE program’s <b>main ()</b> function and to implement the <b>exit () </b>function
to name a few. The thing is, programmers are often unaware this instruction is
in use. The following are some of typical examples that make use of the Stop
and Signal instruction. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><b><span lang=EN-US>exit() </span></b><span lang=EN-US>function of the
SPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><b><span lang=EN-US>printf()</span></b><span lang=EN-US> function and
others used to call PPE library calls (C99, POSIX.1) from the SPE program</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Breakpoints in the SPE program debugger (<b>spu-gdb</b>,
etc.)</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In addition to
the above system-defined usage, the Stop and Signal instruction can of course
be used by the programmer to cause the PPE program to perform processing
instead of the SPE program. For more details, refer to Chapter 6: SPE Event
Handling of the SPE Runtime Management Library Version 2.1, together with the
C/C++ Language Extensions for Cell Broadband Engine Architecture.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>When notifying
interrupts using the Stop and Signal instruction, the SPE delivers 14-bit
signal type information to the PPE. With Linux, signal types are defined as
follows.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>When the most significant bit is “0” (0x0000 &#8211; 0x1fff):
Usable by applications </span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>When the most significant bit is “1” (0x2000 &#8211; 0x3fff):
Reserved by the system</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Signal types in
the range from 0x0001 to 0x1fff except 0x0000 are available for use by the user
in programming processes linked to the PPE program. A list of Linux-reserved
signal types is shown in Table 4.2.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center;page-break-after:
avoid'><a name="_Ref158461652"><span lang=EN-US>Table </span></a><span
lang=EN-US>4.2: Linux-Reserved Signal Types</span></p>

<div align=center>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=138 valign=top style='width:103.8pt;border:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><span lang=EN-US>Signal Type</span></p>
  </td>
  <td width=422 valign=top style='width:316.7pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><span lang=EN-US>Description</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.8pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x0000</span></p>
  </td>
  <td width=422 valign=top style='width:316.7pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Data has
  been executed as an instruction.</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.8pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2000</span><span
  style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>0x20ff</span></p>
  </td>
  <td width=422 valign=top style='width:316.7pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Return
  value from the <b>main()</b> or <b>exit()</b> function of Linux</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2000:
  EXIT_SUCCESS</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2001:
  EXIT_FAILURE</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.8pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2100</span><span
  style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>0x21ff</span></p>
  </td>
  <td width=422 valign=top style='width:316.7pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>PPE
  callback handler running on Linux</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2100:
  ISO/IEC C Standard 9899:1999 (C99)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2101:
  POSIX.1 (IEEE Standard 1003.1)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2102:
  POSIX.4</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x2103:
  OS-dependent system call</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.8pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x3ffe</span></p>
  </td>
  <td width=422 valign=top style='width:316.7pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Detection
  of stack overflow</span></p>
  </td>
 </tr>
 <tr>
  <td width=138 valign=top style='width:103.8pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>0x3fff</span></p>
  </td>
  <td width=422 valign=top style='width:316.7pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Breakpoint
  for debugger</span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.1.4</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Reference Documents</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The MFC provides
a variety of communication mechanisms in addition to those described above. If
you want to learn more about them, refer to Chapter 7: MFC Command of the Cell
Broadband Engine Architecture and Chapter 4: Programming Support for MFC Input
and Output of the C/C++ Language Extensions for Cell Broadband Engine
Architecture. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Refer to Chapter
7: SPE MFC Problem State Facilities of the SPE Runtime Management Library
Version 2.1 for more information about how to use libspe2 to make it possible
to use MFC functions from the PPE program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The Stop and
Signal instruction is described in more detail in Section 2.11: Control
Intrinsics and Section 9.8: SPU and MFC Interrupts Routed to the PPE of the
C/C++ Language Extensions for Cell Broadband Engine Architecture. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Ref153206830"></a><a
name="_Toc188185552"></a><a name="_Toc177361267"></a><a name="_Ref171401583"></a><a
name="_Toc168979013"></a><span lang=EN-US>4.2</span><span lang=EN-US
style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Effective Utilization of DMA Transfer</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This section
complements Section 3.3 presented as an introduction to DMA transfer. We will
now take a closer look into the precautions we have to bear in mind when
programming DMA transfer for the Cell and learn about the techniques for
getting the most from this data transfer system.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><a name="_Ref185848350"><span
lang=EN-US>4.2.1</span></a><span lang=EN-US style='font-size:7.0pt;font-family:
"Times New Roman"'>&nbsp;&nbsp; </span><span lang=EN-US>Transferrable Data Size
and Address Alignment</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:14.15pt'><span lang=EN-US>For ease of
explanation, we have so far talked about DMA transfer of data that is a
multiple of 16 bytes. However, the Cell can also handle DMA transfer smaller
than this data size. Any data that meets the following size and alignment
requirements is pursuant to the Cell’s DMA transfer constraints. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>DMA Transfer Size</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>The data size
must basically be specified in a multiple of 16 bytes (16, 32, 48 , etc.). For
DMA transfer of data smaller than 16 bytes, the Cell also supports data size of
1, 2, 4 or 8 bytes. The maximum data size that can be transferred at one time
is 16K bytes. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Address Alignment in DMA Transfer of More than or Equal
to 16 Bytes</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>When the data to
be transferred is greater than or equal to 16 bytes, the addresses on both
sending and receiving sides (i.e., effective address and LS address) must be
aligned on 16-byte boundaries. The execution performance of DMA transfer is
maximized when the addresses of the data area on both sides begin on a 128-byte
boundary. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Address Alignment in DMA Transfer of Less than 16 Bytes</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>When the data to
be transferred is smaller than 16 bytes, the addresses of the data area on both
sending and receiving sides must satisfy the following conditions.&nbsp; </span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNormal style='margin-left:81.0pt;text-indent:-81.0pt'><span
lang=EN-US>①</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Address alignment is consistent with the transfer size,
i.e., addresses are aligned on the byte boundary equal to the transfer size.</span></p>

<p class=MsoNormal style='margin-left:81.0pt;text-indent:-18.0pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:81.0pt;text-indent:-81.0pt'><span
lang=EN-US>②</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>The lower 4 bits (indicating the relative position from
the 16-byte boundary) of the effective address and the LS address are the same.
</span></p>

<p class=MsoNormal style='margin-left:42.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>Taking DMA
transfer of 4-byte data as an example, Fig. 4.3 graphically illustrates these
requirements. To review again, the effective address and the LS address must
not only be aligned on 4-byte boundaries but also begin at the same relative
position from the 16-byte boundary.</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='margin-left:54.0pt;text-align:center;
page-break-after:avoid'><span lang=EN-US><img width=479 height=175
src="CellProgrammingTutorial.files/image054.jpg" border=0></span></p>

<p class=MsoCaption align=center style='margin-left:54.0pt;text-align:center'><a
name="_Ref163284974"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.3: DMA
Transfer (16 Bytes or Less)</span></p>

<p class=MsoNormal style='margin-left:54.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:53.95pt;text-indent:.1pt'><span
lang=EN-US>Because it is necessary to follow detailed rules, DMA transfer of
less than 16 bytes of data is not very convenient to use, nor can it be very
efficient. Do not use this data size except for special purposes such as signal
notification.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:5.25pt;text-indent:8.9pt'><span
lang=EN-US>Unless the above-mentioned rules are observed, the MFC will stop,
resulting in a DMA alignment error interrupt, which may cause abnormal
termination of both the PPE and SPE programs.&nbsp;&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.2.2</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>DMA Double Buffering</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>For most
applications, DMA transfer accounts for a large percentage of the time required
for processing by the SPE program, which is to say, improving efficiency of DMA
transfer is a significant means of making applications run faster. In this
section, therefore, we will introduce “double buffering”, a technique for
improving the efficiency of DMA transfer, while maximizing SPE performance. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Let’s start by
quickly reviewing the efficiency of the DMA transfer explained in Section 3.3.
With the basic programs explained there, DMA transfer is performed in the
following sequence. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Initiates DMA transfer (GET) to the input buffer.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Waits for Step (1) to complete.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Processes data and stores the calculated result in the
output buffer.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(4)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Initiates DMA transfer (PUT) from the output buffer.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(5)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Waits for Step (4) to complete. </span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(6)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Repeats Steps (1) through (5). </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This sequence
can be described as shown in Fig. 4.4 (a) in terms of time series from the
viewpoint of input/output buffer operations. It can also be diagrammed as shown
in Fig. 4.4 (b) when viewed from the relationship between MFC and SPU
operations. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img width=535 height=238
src="CellProgrammingTutorial.files/image055.jpg" border=0></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref162887387"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.4:
Basic Programs Involving DMA Transfer</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>What’s clear
from Fig. 4.4 (b) is that the MFC does nothing while the SPU is executing its computational
task, or the SPU simply stalls until the DMA transfer by the MFC is complete,
making it impossible to fully realize the SPU’s performance potentials. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>That’s why a
variety of techniques have been developed to achieve more efficient DMA transfer.
Double buffering is one of such techniques. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The double
buffering method uses two separate buffers in parallel for both input and
output so that while one of them is used for computation, the other one can be
filled or emptied by DMA transfer. In contrast to double buffering, the
previously explained DMA transfer using only a single pair of input and output
buffer is called single buffering. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Fig. 4.5 (a)
illustrates the time series processing flow of double buffered DMA transfer.
Fig. 4.5 (b) shows this processing flow reconfigured to highlight the
concurrency between the MFC process and SPU process. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img width=535 height=282
src="CellProgrammingTutorial.files/image056.jpg" border=0></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref176080814"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.5: DMA
Double Buffering Method</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As can be seen
from Fig. 4.5 (b), the MFC performs DMA transfers in parallel with the SPU’s
calculations, and the SPU does not spend a time just to wait for the completion
of the transfers. Double buffering greatly improves the SPE’s computational
capability by enabling DMA transfers in parallel with calculations. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In the case of
the simple DMA transfer scenario described in Section 3.3, parallel execution
of DMA transfers and SPU computations is impossible because every time a DMA
transfer command is issued, it is necessary to verify the completion of
transfer prior to proceeding to the next process. This, however, can be enabled
by making use of the following DMA-related facilities. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>The SPU is inherently capable of performing its task,
simultaneous with and independent of the DMA transfer placed under the control
of the MFC. To take advantage of this, separated functions are provided to
issue the DMA transfer command and to wait for the completion of its execution.
</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Multiple DMA transfer commands, each identified by its
own tag ID, can be issued at one time, while the completion of their executions
can be individually waited for. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:10.5pt'><span
lang=EN-US>DMA double buffering basically proceeds as follows. </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Initiates DMA transfer (GET) to the input buffer 0.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Initiates DMA transfer (GET) to the input buffer 1.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Waits for the completion of DMA transfer (GET) to the
input buffer 0.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(4)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Waits for the completion of DMA transfer (PUT) from the
output buffer 0..</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(5)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Performs necessary computations using the data in the
input buffer 0 and the output buffer 0.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(6)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Initiates DMA transfer (PUT) from the output buffer 0.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(7)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Initiates the next DMA transfer (GET) to the input
buffer 0. </span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(8)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Switches between the input/output buffers 0 and 1.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(9)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Iterates Steps (3) to (8) until all input data is
processed.</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(10)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>
</span><span lang=EN-US>Waits for the completion of the last DMA transfer (PUT)
from the output buffer 0 and 1.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Fig. 4.6
provides a graphic representation of these procedures. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img width=560 height=276
src="CellProgrammingTutorial.files/image057.jpg" border=0></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref176078394"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.6: DMA
Double Buffering Procedure</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Double buffering
is grounded in two basic principles. First, the DMA transfer command is issued
as soon as input/output buffers become ready. Second, completion of DMA
transfer is not verified until the moment the input/output buffers are used for
calculations.&nbsp;&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>At the onset of
double buffering procedures, input data is DMA transferred in succession to
input buffers 0 and 1 (Steps (1) and (2)) because they are both empty.
Immediately after one of the input buffers is filled with data and the
corresponding output buffer are emptied (Steps (3) and (4)), calculations on
the data in the input buffer is executed and the result is stored to the output
buffer (Step (5)) and the result is DMA transferred (PUT) from the output
buffer (Step (6)), simultaneously with the DMA transfer (GET) of the next input
data to the emptied input buffer (Step (7)).&nbsp; These procedures are
repeated (Step (9)), while switching between input/output buffers implemented
in parallel (Step (8)), until processing of all data is complete, and last of
all, waiting for the completion of the DMA transfer (PUT) command issued in
Step (6) (Step (10)). </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Here is an
example of a specific program that allows double buffering in accordance with
the procedures stated above. See List (4-1) that shows a part of the source
code you need to write to copy data from one area of main memory to another
area by making use of the double buffering method. </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>List
(4-1): Sample code for double buffering (partial excerpt)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=715
 style='width:536.4pt;border-collapse:collapse'>
 <tr>
  <td width=715 valign=top style='width:536.4pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;1 #define TOTALSIZE
  (1 &lt;&lt; 24)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;2 #define
  BUFSIZE&nbsp;&nbsp; (1 &lt;&lt; 14)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;3 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;4 char
  ibuf[2][BUFSIZE] __attribute__((aligned(128)));</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;5 char
  obuf[2][BUFSIZE] __attribute__((aligned(128)));</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;6 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;7 unsigned long long
  ea_in, ea_out;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;8 unsigned int
  itag[2] = { 0, 1 };</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;9 unsigned int
  otag[2] = { 2, 3 };</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>10 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>11 void double_buffer(void)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>12 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>13&nbsp;&nbsp;&nbsp;&nbsp;
  int i;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>14&nbsp;&nbsp;&nbsp;&nbsp;
  int cur;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>15 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>16&nbsp;&nbsp;&nbsp;&nbsp;
  cur = 0;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>1</span><span
  style='font-size:9.0pt;font-family:"ＭＳ 明朝"'>７</span><span style='font-size:
  9.0pt;font-family:"Courier New"'> </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>18&nbsp;&nbsp;&nbsp;&nbsp;
  initiate_dma_get_input(ibuf[0],
  itag[0]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 1 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>19 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>20&nbsp;&nbsp;&nbsp;&nbsp;
  initiate_dma_get_input(ibuf[1],
  itag[1]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 2 */ </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>21 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>22&nbsp;&nbsp;&nbsp;&nbsp;
  for (i = 0; i &lt; TOTALSIZE/BUFSIZE-2; i++) {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  wait_dma_completion((1 &lt;&lt; itag[cur]) | (1 &lt;&lt;
  otag[cur]));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Step 3 and 4 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>24 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  compute(ibuf[cur],
  obuf[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 5 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>26 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  initiate_dma_put_result(obuf[cur],
  otag[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 6 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>28 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>29&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  initiate_dma_get_input(ibuf[cur],
  itag[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 7 */ </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>30 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  cur ^= 1;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*
  Step 8 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>32&nbsp;&nbsp;&nbsp;&nbsp;
  }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>33 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>34&nbsp;&nbsp;&nbsp;&nbsp;
  wait_dma_completion((1 &lt;&lt; itag[cur]) | (1 &lt;&lt;
  otag[cur]));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Step 3
  and 4 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>35 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>36&nbsp;&nbsp;&nbsp;&nbsp;
  compute(ibuf[cur],
  obuf[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 5 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>37 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>38&nbsp;&nbsp;&nbsp;&nbsp;
  initiate_dma_put_result(obuf[cur],
  otag[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 6 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>39 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>40&nbsp;&nbsp;&nbsp;&nbsp;
  cur ^= 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*
  Step 8 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>41 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>42&nbsp;&nbsp;&nbsp;&nbsp;
  wait_dma_completion((1 &lt;&lt; itag[cur]) | (1 &lt;&lt; otag[cur]));
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Step 3 and 4 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>43 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>44&nbsp;&nbsp;&nbsp;&nbsp;
  compute(ibuf[cur],
  obuf[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 5 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>45 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>46&nbsp;&nbsp;&nbsp;&nbsp;
  initiate_dma_put_result(obuf[cur],
  otag[cur]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 6 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>47 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>48&nbsp;&nbsp;&nbsp;&nbsp;
  wait_dma_completion((1 &lt;&lt; otag[0]) | (1 &lt;&lt;
  otag[1]));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Step 10 */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>49 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>50 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>51 void
  initiate_dma_get_input(char *buf, unsigned int tagid)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>52 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>53&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcdma64(buf, mfc_ea2h(ea_in), mfc_ea2l(ea_in), BUFSIZE, tagid,
  MFC_GET_CMD);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>54&nbsp;&nbsp;&nbsp;&nbsp;
  ea_in += BUFSIZE;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>55 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>56 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>57 void
  initiate_dma_put_result(char *buf, unsigned int tagid)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>58 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>59&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcdma64(buf, mfc_ea2h(ea_out), mfc_ea2l(ea_out), BUFSIZE, tagid,
  MFC_PUT_CMD);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>60&nbsp;&nbsp;&nbsp;&nbsp;
  ea_out += BUFSIZE;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>61 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>62 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>63 void
  wait_dma_completion(unsigned int mask)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>64 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>65&nbsp;&nbsp;&nbsp;&nbsp;
  spu_writech(MFC_WrTagMask, mask); </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>66&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcstat(MFC_TAG_UPDATE_ALL);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>67 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>68 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>69 void compute(char *src,
  char *dst)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>70 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>71&nbsp;&nbsp;&nbsp;&nbsp;
  memcpy(dst, src, BUFSIZE);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>72 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Lines 1</span><span
  style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>2</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to
  define the size of the buffers for DMA transfer. </span><span lang=EN-US
  style='font-family:"Courier New"'>TOTALSIZE</span><span lang=EN-US> refers to
  the main memory area size (16MB), while </span><span lang=EN-US
  style='font-family:"Courier New"'>BUFSIZE</span><span lang=EN-US> refers to
  the LS buffer capacity (16KB).&nbsp; </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Lines 4</span><span
  style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>9</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to
  define the LS input/output buffers, effective address variables and DMA
  transfer tag IDs used for double buffering. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 14</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to
  define the variable <i>cur</i> that enables switching between the two pairs
  of input/output buffers used in double buffered DMA transfer.&nbsp; </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 16</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Initializes
  the variable <i>cur</i> to “0” in accordance with the input/output buffers
  that are used at the start of the double buffered DMA transfer. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Lines 18</span><span
  style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>20</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to
  issue the DMA transfer (GET) commands that cause the first DMA transfer to
  input buffers 0 and 1.&nbsp;&nbsp; </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 23</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to
  wait for the completion of DMA transfers (GET/PUT) to the input buffer <i>ibuf[cur]</i>
  and the output buffer <i>obuf[cur]. </i>By specifying tag IDs simultaneously
  for the input and output buffers, it is possible to wait for the completion
  of both transfers at one go. Although no DMA transfer command for the output
  buffer issued at the first time of </span><span lang=EN-US style='font-family:
  "Courier New"'>for </span><span lang=EN-US>loop, this will cause no problem
  since .tag IDs with no corresponding DMA transfer command are treated as
  complete.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 25</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Enables
  computation of the data in the input buffer <i>ibuf[cur] </i>and stores the
  obtained result in the output buffer <i>obuf[cur]</i>. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 27</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Issues the
  DMA transfer (PUT) command to the output buffer <i>obuf[cur]</i>.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 29</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Issues the
  DMA transfer (GET) command to the input buffer <i>ibuf[cur]</i> for next
  input data. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 31</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Allows
  switching between the two pairs of input/output buffers. The index of the
  input/output buffers is alternately set to “0” or “1” by exclusive-OR
  operation.&nbsp; </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Lines 34</span><span
  style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>46</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>The last
  two iteration cycles are handled outside the </span><span lang=EN-US
  style='font-family:"Courier New"'>for</span><span lang=EN-US>-loop as they do
  not require DMA transfers (GET). </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 48</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to
  wait for the completion of the last DMA transfer (PUT) from the output buffer
  0 and 1. </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US><a
href="src/example4_1/">Click here for the source code for double buffering. </a></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>For more
information on double buffering, refer to Chapter 19: DMA Transfers and
Inter-Processor Communication and Section 24.1: DMA Transfers of the Cell
Broadband Engine Programming Handbook. </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.2.3</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>MFC Atomic Update</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>A special DMA
transfer mechanism called MFC atomic update is used when exclusive read/write
operations must be performed by the SPE programs sharing variables in the main
memory. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>For a better
understanding of this mechanism, let’s get started with a program that allows
an SPE to increment a shared variable on the main memory using normal DMA
transfer. As shown in List (4-2), the value of the variable is DMA transferred
(GET) to the SPE for increment operation and the incremented value is written
back to the main memory by DMA transfer (PUT). </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-2): Increment program using normal
DMA transfers</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=715
 style='width:536.4pt;border-collapse:collapse'>
 <tr>
  <td width=715 valign=top style='width:536.4pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;1 #include
  &lt;spu_intrinsics.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;2 #include
  &lt;spu_mfcio.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;3</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;4 int counter
  __attribute__((aligned(128)));</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;5</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;6 int main(unsigned
  long long spe, unsigned long long argp, unsigned long long envp)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;7 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;
  int i;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;9</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>10&nbsp;&nbsp;&nbsp;&nbsp;
  for (i = 0; i &lt; 10000; i++) {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcdma64(&amp;counter, mfc_ea2h(argp), mfc_ea2l(argp), sizeof(int), 0,
  MFC_GET_CMD);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_writech(MFC_WrTagMask, 1 &lt;&lt; 0);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcstat(MFC_TAG_UPDATE_ALL);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>14</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  counter++;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>16</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcdma64(&amp;counter, mfc_ea2h(argp), mfc_ea2l(argp), sizeof(int), 0,
  MFC_PUT_CMD);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_writech(MFC_WrTagMask, 1 &lt;&lt; 0);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>19&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcstat(MFC_TAG_UPDATE_ALL);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>20&nbsp;&nbsp;&nbsp;&nbsp;
  }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>21</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>22&nbsp;&nbsp;&nbsp;&nbsp;
  return 0;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>23 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US><a
href="src/example4_2/">Click here for the source code for increment program
using normal DMA transfers. </a></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This program
works as intended when it is used only by a single SPE. However, a problem
arises if it is executed simultaneously by multiple SPEs.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Fig. 4.7 shows
what would happen if the increment program in List (4-2) is executed by two
SPEs. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=581 height=347
src="CellProgrammingTutorial.files/image058.jpg"></span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref168996658"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.7:
Invalid Increment Operation</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In Fig. 4.7 (a),
the shared variable is incremented properly as the operation of SPE2 is
appropriately timed with that of SPE1. As shown in Fig. 4.7 (b), however, the
variable value cannot be incremented in a way it should, if SPE2 accesses the
variable before it is incremented by SPE1 and attempts to overwrite its value
after it is incremented by SPE1. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Put simply, the
use of normal DMA transfer is not fit for updating variables shared by multiple
SPEs. Nevertheless, the problem of incoherent variable values described in Fig.
4.7 (b) can be avoided only if it is possible to start all over again from
reading the variable value when an update is performed by some other SPE after
accessing the variable for the first time. This is where the MFC atomic update
facility proves its usefulness.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=288 height=368
src="CellProgrammingTutorial.files/image059.jpg"></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref175479409"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.8:&nbsp;
MFC Atomic Update </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The GETLLAR (<u>Get</u>
<u>L</u>ock <u>L</u>ine <u>a</u>nd <u>R</u>eserve) and PUTLLC (<u>P</u>ut <u>L</u>ock
<u>L</u>ine <u>C</u>onditional) commands are used for DMA transfer to perform
atomic accesses, instead of GET and PUT commands. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The GETLLAR
command causes the data in<span style='color:blue'> </span>the main memory to
be brought into the LS, enabling the SPE to know thereafter whether the data’s
rightful home area in the main memory is updated by some other SPE. The data
accessed by the GETLLAR command and updated by the SPE is written back to the
main memory by using the PUTLLC command. The PUTLLC command fails and the data
is not written at all if its home area in the memory is updated by some other
SPE. Upon detection of the failure of the PUTLLC command, the SPE retries by
repeatedly issuing GETLLAR command and updating the data loaded until the
PUTLLC command is expected successfully. In this way, atomic update operations
by the MFC ensure infallible updates of shared variables.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>List (4-3) shows
an example source code for a program that makes use of the MFC atomic update
commands for incrementing a shared variable. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-3): Increment program utilizing MFC
atomic update operations (partial excerpt)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=715
 style='width:536.4pt;border-collapse:collapse'>
 <tr>
  <td width=715 valign=top style='width:536.4pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;1 #include
  &lt;spu_intrinsics.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;2 #include
  &lt;spu_mfcio.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;3</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;4 int
  counter[32] __attribute__((aligned(128)));</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;5</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;6 int main(unsigned
  long long spe, unsigned long long argp, unsigned long long envp)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;7 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;
  int i;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;9</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>10&nbsp;&nbsp;&nbsp;&nbsp;
  for (i = 0; i &lt; 10000; i++) {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  do {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcdma64(counter, mfc_ea2h(argp), mfc_ea2l(argp), 128, 0,
  MFC_GETLLAR_CMD);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_readch(MFC_RdAtomicStat);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>14</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  counter[0]++;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>16</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  spu_mfcdma64(counter, mfc_ea2h(argp), mfc_ea2l(argp), 128, 0,
  MFC_PUTLLC_CMD);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99FF99'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  } while(spu_readch(MFC_RdAtomicStat) &amp; MFC_PUTLLC_STATUS);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>19&nbsp;&nbsp;&nbsp;&nbsp;
  }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>20</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>21&nbsp;&nbsp;&nbsp;&nbsp;
  return 0;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>22 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 4</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Defines the
  buffer size for DMA transfer. Note that the buffers used for MFC atomic updates
  must be able to deal with DMA transfer of 128-byte data that begins on the
  128-byte boundary. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 12</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Issues the
  GETLLAR command to read the shared variable data in the main memory.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 13</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Whenever an
  MFC atomic update command is issued, it is necessary to read the value of the
  MFC_RdAtomicStat channel using the built-in <b>spu_readch()</b> function to
  wait for the completion of DMA transfer. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 15</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Increments
  the shared variable value.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 17</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Issues the PUTLLC
  command to write the incremented value to the shared variable in the main
  memory. Writing to the variable is prevented when it has been updated by some
  other SPE.&nbsp; </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 18</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Checks
  whether the PUTLLC command is executed successfully by reading the value of
  the MFC_RdAtomicStat channel using the built-in <b>spu_readch()</b> function.
  In the case of failure, goes back to the line 12. </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US><a
href="src/example4_3/">Click here for the source code for increment program utilizing
MFC atomic update operations. </a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As we have seen,
the MFC atomic update sequence makes it possible to exclusively update
variables shared by multiple SPEs. It also helps implement a variety of
synchronization mechanisms such as semaphore and mutex. In addition, atomic
updates can be used to update variables shared with the PPE that incorporates a
similar facility. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Special care
must be taken when using MFC atomic update commands because they differ from
normal DMA transfer commands not only in transfer size but also in the
procedure to wait for command completion as mentioned above. For more
information, refer to Section 20.3: SPE Atomic Synchronization of the Cell
Broadband Engine Programming Handbook.</span></p>

<span lang=EN-US style='font-size:10.5pt;font-family:Century'><br clear=all
style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Ref153206840"></a><a
name="_Toc168979014"></a><a name="_Toc188185553"></a><a name="_Toc177361268"></a><a
name="_Ref171401603"></a><span lang=EN-US>4.3</span><span lang=EN-US
style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Representation of Data Shared between PPE and SPE</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This section
explains the precautions on data sharing between the PPE and SPE. For the
efficiency of programming, data types shared by multiple source codes are
ordinarily defined in a common header file, so let’s start with the important
points to remember when defining the data types shared between the PPE program
and the SPE program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.3.1</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Differences in PPE and SPE Data Representations</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In the C
language, the same data type can be expressed in different ways as this programming
language has no mandatory representation rules. The most commonly used data
models are ILP32 and LP64. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>ILP32</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>Data size of the
<i>int</i> type, <i>long</i> type and pointer type is 32 bits long. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>LP64 (I32LP64)</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>Data size of the
<i>int</i> type is 32 bits long, while that of the <i>long</i> type and pointer
type is 64 bits long. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>ILP is an
acronym for <u>I</u>nteger, <u>L</u>ong Integer and <u>P</u>ointer. The <i>long
long</i> type is always 64 bits long irrespective of the data model used. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>PPE programs can
be classified into 32-bit programs based on ILP32 and 64-bit programs based on
LP64. All SPE programs use ILP32. Table 4.3 provides a list of data types and
their sizes used in PPE and SPE programs. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center;page-break-after:
avoid'><a name="_Ref177355165"><span lang=EN-US>Table </span></a><span
lang=EN-US>4.3: Program Data Representations</span></p>

<div align=center>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=162 rowspan=2 valign=top style='width:121.15pt;border:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right;word-break:break-all'><b><span
  lang=EN-US>Representation</span></b></p>
  <p class=MsoNormal><b><span lang=EN-US>&nbsp;</span></b></p>
  <p class=MsoNormal><b><span lang=EN-US>Data Size</span></b></p>
  </td>
  <td width=293 colspan=2 style='width:220.1pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>PPE Program</span></b></p>
  </td>
  <td width=147 rowspan=2 style='width:110.05pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>SPE Program</span></b></p>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>(ILP32)</span></b></p>
  </td>
 </tr>
 <tr>
  <td width=147 style='width:110.05pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>32-bit Program</span></b></p>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>&nbsp;(ILP32)</span></b></p>
  </td>
  <td width=147 style='width:110.05pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>64-bit Program</span></b></p>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>(LP64)</span></b></p>
  </td>
 </tr>
 <tr>
  <td width=162 valign=top style='width:121.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><i><span lang=EN-US>int</span></i><span lang=EN-US> Type</span></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>32
  bits</span></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>32
  bits</span></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>32
  bits</span></p>
  </td>
 </tr>
 <tr>
  <td width=162 valign=top style='width:121.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><b><i><span lang=EN-US style='color:red'>long</span></i><span
  lang=EN-US style='color:red'> Type</span></b></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><b><span lang=EN-US
  style='color:red'>32 bits</span></b></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><b><span lang=EN-US
  style='color:red'>64 bits</span></b></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><b><span lang=EN-US
  style='color:red'>32 bits</span></b></p>
  </td>
 </tr>
 <tr>
  <td width=162 valign=top style='width:121.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><i><span lang=EN-US>long long </span></i><span lang=EN-US>Type</span></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>64
  bits</span></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>64
  bits</span></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><span lang=EN-US>64
  bits</span></p>
  </td>
 </tr>
 <tr>
  <td width=162 valign=top style='width:121.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal><b><span lang=EN-US style='color:red'>Pointer Type</span></b></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><b><span lang=EN-US
  style='color:red'>32 bits</span></b></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><b><span lang=EN-US
  style='color:red'>64 bits</span></b></p>
  </td>
  <td width=147 valign=top style='width:110.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=right style='text-align:right'><b><span lang=EN-US
  style='color:red'>32 bits</span></b></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As highlighted
in red, <i>long </i>type and pointer type LP64 PPE programs differ from SPE
programs in terms of data size (64 bits as opposed to 32 bits). Also note that
the pointer types logically indicate the different kinds of address &#8211; For PPE
programs, it points to the effective address and for SPE programs, it points to
the LS address, although this difference is not clear in the above table.&nbsp;
</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.3.2</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Precautions on Data Sharing between PPE and SPE</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>List (4-4) shows
the DMA transfer parameter extracted from the sample program in Section 3.3,
where the <i>long long </i>type 64-bit data is used to represent effective
addresses. Using this as an example, let’s discuss the points to keep in mind
when sharing data between PPE and SPE. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-4): Data representation of shared
DMA transfer parameter (unsigned <i>long long </i>type<i>)</i></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFFF;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>typedef struct {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; unsigned
  long long ea_in;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Effective address of input
  data&nbsp; */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; unsigned
  long long ea_out;&nbsp;&nbsp;&nbsp;&nbsp; /* Effective address of output data
  */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; int
  size;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; int
  pad[3];</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>} abs_params_t;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Since <i>ea_in </i>and<i>
ea_out</i> are both addresses, it may seem more reasonable to describe them, as
shown in List (4-5), by means of pointer type data. In fact, the use of this
data type is perfectly justifiable, on the condition that the same data
representation, namely ILP32, is used for both PPE and SPE programs. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>List (4-5):
Fallacious data representation of shared DMA transfer parameter (pointer type)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFFF;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>typedef struct {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; int
  *ea_in;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Effective address of input data&nbsp; */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; int
  *ea_out;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  /* Effective address of output data */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; int
  size;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; int pad;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>} abs_params_t;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Remember,
however, the data size of the pointer type is 64 bits in LP64-based PPE
programs, while it is always 32 bits in SPE programs. This means that data
placement in the structure may differ between the two programs as shown in
Table 4.4, which, in turn, may make it impossible to reference correct data and
obtain a correct result. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center;page-break-after:
avoid'><a name="_Ref159149763"><span lang=EN-US>Table </span></a><span
lang=EN-US>4.4: Data Structure</span></p>

<div align=center>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=628
 style='width:471.2pt;border-collapse:collapse'>
 <tr>
  <td width=419 colspan=2 style='width:314.1pt;border:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>PPE Program</span></b></p>
  </td>
  <td width=209 rowspan=2 style='width:157.1pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>SPE Program</span></b></p>
  </td>
 </tr>
 <tr>
  <td width=209 style='width:157.05pt;border:solid windowtext 1.0pt;border-top:
  none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>32-bit Program</span></b></p>
  </td>
  <td width=209 style='width:157.05pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  lang=EN-US>64-bit Program</span></b></p>
  </td>
 </tr>
 <tr>
  <td width=209 style='width:157.05pt;border:solid windowtext 1.0pt;border-top:
  none;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US><img
  border=0 width=185 height=53 src="CellProgrammingTutorial.files/image060.jpg"></span></p>
  </td>
  <td width=209 style='width:157.05pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US><img
  border=0 width=185 height=53 src="CellProgrammingTutorial.files/image061.jpg"></span></p>
  </td>
  <td width=209 style='width:157.1pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US><img
  border=0 width=185 height=53 src="CellProgrammingTutorial.files/image060.jpg"></span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>When <i>long</i>
type or pointer type data is included in the data shared through DMA transfers
and so on, be aware of the possibility that data cannot always be referenced
exactly. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Moreover, the example
described above is faulty in the first place, because the pointer, which should
point to the LS address, is retaining the effective address. This is more
critical than the discrepancy in the address data size. Even if an effective
address of <i>int</i> data is received from the PPE program, the SPE program
cannot access and handle data through the pointer, i.e., it always requires
data to be DMA transferred to its LS. List (4-6) shows a bad example of source
code that does not operate normally when used for the SPE program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-6): Erroneous effective address
reference by the SPE program</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>volatile abs_params_t param
  __attribute__((aligned(16)));</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>for (i = 0; i &lt;
  param.size; i++) {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp;
  *(param.ea_out + i) = *(param.ea_in + i) + 10;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>}</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.3.3</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>How to Make Programming Unaffected by Data Representations</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As explained in
the previous section, data size varies between the PPE and SPE programs,
depending on the data type and representation. The <i>long</i> and pointer
types, for example, often cause problems when used in the data to be shared by
the PPE and SPE programs. The following describes the techniques for
eliminating these problems. Using either one of them will assure you accurate
programming independent of data representation. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Avoid using <i>long </i>type and pointer type data.</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>Do not use <i>long</i>
type and pointer type data whose size differs between the PPE and the SPE.
Instead, explicitly use the<i> int</i> type for 32-bit integer data, the <i>long
long</i> type for 64-bit integer data, and the <i>unsigned long long</i> type
for the effective address. The effective address represented by the PPE’s
pointer type can be converted into the <i>unsigned long long</i> type by
performing pointer casting shown in List (4-7). In this list, casting is
performed in two steps &#8211; first to the unsigned<i> long</i> type and then to the
unsigned <i>long long</i> type &#8211; in order to prevent sign
extension.&nbsp;&nbsp; </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>List
(4-7): Effective address representation using the unsigned <i>long long </i>type</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFFF;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int *in, *out;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>abs_params.ea_in&nbsp; = (unsigned
  long long) (unsigned long) in;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>abs_params.ea_out =
  (unsigned long long) (unsigned long) out;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Make effective use of data types whose size is
explicitly defined.</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>Data types
defined by </span><span lang=EN-US style='font-family:"Courier New"'>stdint.h</span><span
lang=EN-US> can be used as another way of eliminating problems associated with
data representations. Data types defined by </span><span lang=EN-US
style='font-family:"Courier New"'>stdint.h</span><span lang=EN-US>, e.g. <i>int32_t</i>
and <i>int64_t</i>, are suitable for use for shared data because their data
length is explicitly defined. For the effective address, we recommend using the
<i>uint64_t</i> type shown in List (4-8). </span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>List
(4-8): Explicit data type definition</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>typedef struct {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; uint64_t
  ea_in;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; uint64_t
  ea_out;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; uint32_t
  size;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; uint32_t
  pad[3];</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>} abs_params_t</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>As for the
effective address, the following code causes casting to the <i>uint64_t</i>
type from the PPE program’s pointer type. The <i>uintptr_t</i> type is an
integer type of the same size as the pointer type. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-9):&nbsp; Effective address
representation using the data type defined by </span><span lang=EN-US
style='font-family:"Courier New"'>stdint.h</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFFF;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>#include &lt;stdint.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int *in, *out;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>abs_params.ea_in&nbsp; =
  (uint64_t) (uintptr_t) in;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>abs_params.ea_out =
  (uint64_t) (uintptr_t) out;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>All in all, data
representation conversion is vital for data sharing. By avoiding the use of
data types such as<i> long </i>and pointer that are dependent on data
representation, the PPE program, regardless of whether it is 32 bits or 64
bits, can correctly share data with the SPE program.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><a name="_Ref153206848"><span
lang=EN-US>4.3.4</span></a><span lang=EN-US style='font-size:7.0pt;font-family:
"Times New Roman"'>&nbsp;&nbsp; </span><span lang=EN-US>PPE Program Compilation
</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>When compiling
PPE programs, be sure to specify the </span><b><span lang=EN-US
style='font-family:Arial'>-m32</span></b><span lang=EN-US> option (for 32-bit
programs) or the </span><b><span lang=EN-US style='font-family:Arial'>-m64</span></b><span
lang=EN-US style='font-family:Arial'> </span><span lang=EN-US>option (for
64-bit programs) as shown in the following examples. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Example (4-1):&nbsp; Compiling 32-bit PPE
programs</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ gcc <span
  style='color:red'>-m32</span> sample_ppe.c</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Example (4-2): Compiling 64-bit PPE
programs</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ gcc <span
  style='color:red'>-m64</span> sample_ppe.c</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>When compiled
without specifying the </span><b><span lang=EN-US style='font-family:Arial'>&#8211;m</span></b><span
lang=EN-US> option, data size (32 or 64 bits) of the created PPE program
depends on the compiler used. Even when compiled using the same </span><b><span
lang=EN-US style='font-family:Arial'>gcc</span></b><span lang=EN-US>, moreover,
it is not certain that exactly the same PPE program will be generated in every
development environment. In order to create PPE programs that work correctly,
it is important to be aware of the data size throughout the programming
process. </span></p>

<span lang=EN-US style='font-size:10.5pt;font-family:Century'><br clear=all
style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Ref163376816"></a><a
name="_Toc188185554"></a><a name="_Toc177361269"></a><a name="_Ref171401625"></a><a
name="_Toc168979015"></a><a name="_Ref166563064"></a><a name="_Ref163377834"></a><a
name="_Ref163377684"></a><a name="_Ref163377191"></a><span lang=EN-US>4.4</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Vector Data Alignment</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This section
describes the alignment of vector data from the pro-hardware point of view to
complement the information provided in Section 2.2. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.4.1</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Data Load and Store</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>First, let us reconfirm
what “load” and “store” exactly mean. Neither PPE nor SPE can directly use
memory data for computations. Data in the memory is first copied into a
register that allows high-speed access. Then calculations are performed on the
data retained in the register. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=491 height=150
src="CellProgrammingTutorial.files/image062.jpg"></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref163455595"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.9:
Load and Store</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:5.25pt;text-indent:5.25pt'><span
lang=EN-US>As shown in Fig. 4.9, “load” refers to the operation performed by
the PPE or SPE whereby data is transferred from the memory to the register.
Conversely, “store” means writing the register’s data back to the memory. These
operations invariably impose size and alignment restrictions on the data to be
transferred, and if these restrictions are not observed, it becomes impossible
to load and store data, or to perform computations that yield expected results.
</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.4.2</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Load and Store of Vector Data</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Designed to
handle data in the form of vectors, the PPE and SPE incorporate multiple 16-byte
registers, while load and store of vector data using these registers are
restricted as follows. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Data size</span></p>

<p class=MsoNormal style='margin-left:39.0pt'><span lang=EN-US>The size of data
to be loaded or stored in one operation must be equal to the entire length (16
bytes) of a register. No data smaller than this size can be loaded and stored
between the memory and the register. </span></p>

<p class=MsoNormal style='margin-left:39.0pt;text-indent:-39.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Alignment</span></p>

<p class=MsoNormal style='margin-left:39.0pt'><span lang=EN-US>The address of
the data storage location used in load and store operations must be aligned on
a 16-byte boundary. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Performing load
and store operations without aligning the initial address of vector data to a
16-byte boundary will result in obtaining a value the programmer does not
expect. Even after this happens, the PPE and SPE programs carry on processing
normally in almost all environments, making it extremely difficult for the
programmer to detect the error and its cause. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=496 height=135
src="CellProgrammingTutorial.files/image063.jpg">&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref163461845"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.10:
Loading of Unaligned Vector Data</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In the above
Fig. 4.10, the initial address of the scalar array<i> a</i> is not aligned on
the 16-byte boundary. This means that instead of all elements of the scalar
array<i> a</i>, which the programmer intends to load to the register, only the
first and second elements of the scalar array <i>a</i> are loaded, together
with the extraneous values X and Y. What’s worse is that in the subsequent
calculation of the variable <i>va</i>, the values X and Y are used instead of
the third and fourth elements of the scalar array <i>a</i>. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.4.3</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Allocation of Aligned Memory Area</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The need to
align each vector data appropriately on a boundary was explained in the
previous section. Now let’s look at the method of allocating byte-aligned
memory area. This is performed either statically or dynamically.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Static memory allocation using the</span><span
lang=EN-US style='font-family:"Courier New"'> aligned </span><span lang=EN-US>attribute</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>Data can be
aligned on the arbitrary boundary by assigning the </span><span lang=EN-US
style='font-family:"Courier New"'>aligned </span><span lang=EN-US>attribute
when declaring a variable or when defining a type. This attribute is effective
only for static allocation of global variables. It does not guarantee that
variables allocated on a stack, such as the local variables declared within a
function, can also be aligned.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-10): Static allocation (16-byte
alignment) using the </span><span lang=EN-US style='font-family:"Courier New"'>aligned</span><span
lang=EN-US> attribute</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int&nbsp; a[4]&nbsp; __attribute__((aligned(16)))</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>char b[16]
  __attribute__((aligned(16)))</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Dynamic memory allocation using the <b>memalign()</b>
or <b>posix_memalign()</b> function </span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>When the local
variables within the program’s function or the memory area size to be allocated
is indeterminate, dynamic reservation can be performed using either the <b>memalign()</b>
or the <b>posix_memalign() </b>function. The arguments and return value of
these functions are shown in API Definitions (4-1) and (4-2). </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>API Definition (4-1): Prototype declaration
in the <b>memalign()</b> function</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New";color:blue'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>void *mamalign(size_t <i>boundary</i>,
  size_t <i>size</i>);</span></p>
  <p class=MsoNormal align=left style='text-align:left;text-autospace:none'><span
  lang=EN-US style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=739
 style='width:554.3pt;border-collapse:collapse'>
 <tr>
  <td width=130 valign=top style='width:97.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=left style='margin-left:5.25pt;text-align:left;
  text-indent:-5.25pt;layout-grid-mode:char'><span lang=EN-US>First argument</span></p>
  </td>
  <td width=104 valign=top style='width:78.1pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>boundary</span></i></p>
  </td>
  <td width=505 colspan=2 valign=top style='width:378.5pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='margin-right:37.25pt;layout-grid-mode:char'><span
  lang=EN-US>Specifies the boundary size for the memory area to be allocated.</span></p>
  </td>
 </tr>
 <tr>
  <td width=130 valign=top style='width:97.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Second
  argument</span></p>
  </td>
  <td width=104 valign=top style='width:78.1pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>Size</span></i></p>
  </td>
  <td width=505 colspan=2 valign=top style='width:378.5pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='margin-right:37.25pt;layout-grid-mode:char'><span
  lang=EN-US>Specifies the size of the memory area to be allocated.</span></p>
  </td>
 </tr>
 <tr>
  <td width=130 valign=top style='width:97.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Return
  value</span></p>
  </td>
  <td width=104 valign=top style='width:78.1pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>&nbsp;</span></i></p>
  </td>
  <td width=505 colspan=2 valign=top style='width:378.5pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='margin-right:37.25pt;layout-grid-mode:char'><span
  lang=EN-US>On success, returns the pointer to the allocated memory area. On
  failure, NULL is returned and an error code is set to <i>errno</i>.</span></p>
  </td>
 </tr>
 <tr>
  <td width=470 colspan=3 valign=top style='width:352.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>&nbsp;</span></p>
  </td>
  <td width=269 style='width:201.75pt;padding:0mm 0mm 0mm 0mm'>
  <p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>
  </td>
 </tr>
 <tr>
  <td width=130 style='width:97.5pt;padding:0mm 0mm 0mm 0mm'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"ＭＳ Ｐゴシック"'>&nbsp;</span></p>
  </td>
  <td width=104 style='width:78.0pt;padding:0mm 0mm 0mm 0mm'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"ＭＳ Ｐゴシック"'>&nbsp;</span></p>
  </td>
  <td width=236 style='width:177.0pt;padding:0mm 0mm 0mm 0mm'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"ＭＳ Ｐゴシック"'>&nbsp;</span></p>
  </td>
  <td width=269 style='width:201.75pt;padding:0mm 0mm 0mm 0mm'>
  <p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
  style='font-size:12.0pt;font-family:"ＭＳ Ｐゴシック"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>API Definition (4-2): Prototype declaration
in the <b>posix_memalign()</b> function</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New";color:blue'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int posix_mamalign(void **<i>memptr</i>,
  size_t <i>alignment</i>, size_t <i>size</i>);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=689
 style='width:516.6pt;border-collapse:collapse'>
 <tr>
  <td width=140 valign=top style='width:104.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>First
  argument</span></p>
  </td>
  <td width=95 valign=top style='width:71.0pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>memptr</span></i></p>
  </td>
  <td width=454 valign=top style='width:340.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Specifies
  the pointer to the pointer variable used to store the address of the
  allocated memory area. </span></p>
  </td>
 </tr>
 <tr>
  <td width=140 valign=top style='width:104.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Second
  argument</span></p>
  </td>
  <td width=95 valign=top style='width:71.0pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>alignment</span></i></p>
  </td>
  <td width=454 valign=top style='width:340.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Specifies
  the boundary size for the memory area to be allocated. </span></p>
  </td>
 </tr>
 <tr>
  <td width=140 valign=top style='width:104.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Third
  argument</span></p>
  </td>
  <td width=95 valign=top style='width:71.0pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>Size</span></i></p>
  </td>
  <td width=454 valign=top style='width:340.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Specifies
  the size of the memory area to be allocated.</span></p>
  </td>
 </tr>
 <tr>
  <td width=140 valign=top style='width:104.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Return
  value</span></p>
  </td>
  <td width=95 valign=top style='width:71.0pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><i><span lang=EN-US>&nbsp;</span></i></p>
  </td>
  <td width=454 valign=top style='width:340.8pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>On success,
  returns “0”. On failure, returns a value other than “0”.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>For the PPE
program, use the <b>posix_mamalign()</b> function, as use of the <b>memalign()</b>&nbsp;
function is not recommended. In contrast, the <b>memalign()</b> function is the
only function that can be used with the SPE program; the <b>posix_memalign()</b>
function is not available. </span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt'><span lang=EN-US>Examples (4-3)
and (4-4) demonstrate how to use the <b>memalign()</b> and <b>posix_memalign()</b>
functions.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Example (4-3): Dynamic reservation (16-byte
alignment) using the <b>memalign()</b> function (SPE program)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>#include &lt;malloc.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>char *buffer;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>buffer = (char *)
  memalign(16, 1024);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Example (4-4): Dynamic reservation (16-byte
alignment) using the <b>posix_memalign()</b> function </span></p>

<p class=MsoNormal style='text-indent:73.5pt'><span lang=EN-US>(PPE program)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFFF;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>#define _XOPEN_SOURCE 600</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>#include &lt;stdlib.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>char *buffer;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>ret =
  posix_memalign(&amp;buffer, 16, 1024);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The memory area
available for the SPE program is only 256KB. From the standpoint of efficient
use of this limited usable memory space, dynamic reservation of the memory area
should basically be avoided. This is because fragmentation of the available
free space occurs every time dynamic allocation is set and reset and this
gradually makes it impossible to allocate a sufficiently large memory area at
one time.&nbsp;&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.4.4</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Load and Store of Unaligned Data</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As you may now
understand, vector data must be aligned on an appropriate boundary. If not
aligned, load and store operations become quite complex, requiring a number of
extra processes. Just for your reference, the following describes the procedure
for loading and storing unaligned vector data for processing by the SPE
program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>List (4-11)
shows an example of a function used to load vector data that is not aligned on
a 16-byte boundary. More specifically, the <b>vector_load_unaligned()</b>
function loads the register with 16 bytes of data accessed from the any address
specified by the first argument and returns the result of processing by the SPE
program in the form of vector data. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-11): Load function for unaligned vector
data (for SPE program)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;1 vector unsigned
  char vector_load_unaligned(vector unsigned char *ptr)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;2 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;
  vector unsigned char qw0, qw1, qw;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;
  int shift;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;5</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;
  qw0 = *(ptr &amp; ‾0xf);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;
  qw1 = *((ptr+1) &amp; ‾0xf);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;
  shift = (unsigned int) ptr &amp; 0xf;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;
  qw = spu_or(spu_slqwbyte(qw0, shift), spu_rlmaskqwbyte(qw1, shift-16));</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>10</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>11&nbsp;&nbsp;&nbsp;&nbsp;
  return (qw);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>12 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 3</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Declares
  the variables <i>qw0, qw1 </i>and<i> qw </i>&nbsp;necessary to be used to
  load vector data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 4</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Declares
  the variable <i>shift</i> used to cause a byte shift in the vector data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 6</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Loads the
  register with a 16-byte value including the left portion of the vector data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 7</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Loads the
  register with a 16-byte value including the right portion of the vector data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 8</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Assigns the
  offset from the 16-byte boundary to the variable <i>shift</i>.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 9</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the <b>spu_slqwbyte()</b>
  function, left-shifts the left portion of vector data for a distance
  equivalent to the offset value. </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the <b>spu_rlmaskqwbyte()</b>
  function, right-shifts the right portion of vector data for a distance
  equivalent to the offset value. </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the <b>spu_or()</b>
  function, merges the two shifted data. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 11</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Returns the
  appropriately loaded 16-byte value. </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The <b>vector_store_unaligned()</b>
function shown in List (4-12) is an example of a function used to store vector
data that is not aligned on a 16-byte boundary. More specifically, this
function stores the 16 bytes of data specified by the first argument to the any
address specified by the second argument. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-12):&nbsp; Store function for
unaligned vector data (for SPE program)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;1 void
  vector_store_unaligned(vector unsigned char qw, vector unsigned char *ptr)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;2 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;
  vector unsigned char qw0, qw1;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;
  vector unsigned char mask = spu_splats((unsigned char) 0xff);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;
  int shift;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;6</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;
  qw0 = *(ptr &amp; 0xf);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;
  qw1 = *((ptr+1) &amp; 0xf);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;
  shift = (unsigned int) ptr &amp; 0xf;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>10&nbsp;&nbsp;&nbsp;&nbsp;
  mask = spu_rlmaskqwbyte(mask, -shift);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>11&nbsp;&nbsp;&nbsp;&nbsp;
  qw = spu_rlqwbyte(qw, -shift);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>12&nbsp;&nbsp;&nbsp;&nbsp;
  *(ptr &amp; 0xf) = spu_sel(qw0, qw, mask);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>13&nbsp;&nbsp;&nbsp;&nbsp;
  *((ptr+1) &amp; 0xf) = spu_sel(qw1, qw, mask);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>14</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>15&nbsp;&nbsp;&nbsp;&nbsp;
  return;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>16 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 3</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Declares
  the variables <i>qw0 </i>&nbsp;and <i>qw1 </i>necessary to be used to store
  vector data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 4</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Declares
  the variable <i>shift</i> used to specify the mask value for merging vector
  data.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 5</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Declares
  the variable <i>mask </i>used to cause a byte shift in the vector data</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 7</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Loads the
  16-byte value of the storage location on the memory where the left portion of
  vector data is stored. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 8</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Loads the
  16-byte value of the storage location on the memory where the right portion
  of vector data is stored.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 9</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Assigns the
  byte shift value for the storage location on the memory to the variable <i>shift</i>.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 10</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the<b>
  spu_rlmaskqwbyte() </b>function,<b> </b>assigns the mask value to the
  variable <i>mask</i> for merging the vector data with the storage area on the
  memory. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 11</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the <b>spu_rlqwbyte()</b>
  function, generates merged data to be stored by rotating the vector data to
  the right direction equivalent to the <i>shift </i>bytes.</span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 12</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the <b>spu_sel()</b>
  function, merges the left portion of the vector data with the storage area on
  the memory and writes it back to the original memory area. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 13</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Using the <b>spu_sel()
  </b>function, merges the right portion of the vector data with the storage
  area on the memory and writes it back to the original memory area.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>As can be seen from the above example, load
and store operations for the memory area where data is not aligned cannot be
performed without going through a multitude of processes. In SIMD programming,
it is very important to ensure that data is aligned on an appropriate boundary.
</span></p>

<span lang=EN-US style='font-size:10.5pt;font-family:Century'><br clear=all
style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Ref153206855"></a><a
name="_Toc188185555"></a><a name="_Toc177361270"></a><a name="_Ref171401637"></a><a
name="_Toc168979016"></a><a name="_Ref163377851"></a><a name="_Ref163377718"></a><a
name="_Ref163377239"></a><a name="_Ref163376853"></a><span lang=EN-US>4.5</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Scalar Operations on SPE</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The SPE is a
processor optimized for SIMD operations, yet it can be adapted for scalar
operations only if some precautions are taken. In this section, therefore, we
will investigate into the efficiency of scalar operations by the SPE, while
paying attention to some of basic do’s and don’ts.&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.5.1</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Preferred Scalar Element</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Many of today’s
architectures have separate registers for scalar data and vector data. On the
other hand, the SPE offers no registers dedicated to scalar data and thus uses
the same register for both types of data. The SPE also provides no load, store
and arithmetic instructions designed specifically for scalar data. Scalar
operations on this processor are performed by using SIMD instructions.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Scalar data does
not need to use the entire register; it only uses a predetermined part of the
register called the preferred scalar element. According to the scalar data type
and size, the position of the preferred scalar element is determined as shown
in Fig. 4.11.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=513 height=242
src="CellProgrammingTutorial.files/image064.jpg"></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref162794288"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.11:
Preferred Scalar Element</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In more detail, <i>char</i>
type scalar data is located to Byte 3, <i>short</i> type to Bytes 2</span><span
style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>3, <i>int</i> type and <i>float</i>
type to Bytes 0</span><span style='font-family:"ＭＳ 明朝"'>〜</span><span
lang=EN-US>3, and <i>long long</i> type and <i>double</i> type to Bytes 0</span><span
style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>7. In addition to these
data, the pointer type used to indicate the address is also assigned to Bytes 0</span><span
style='font-family:"ＭＳ 明朝"'>〜</span><span lang=EN-US>3. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The SPE cannot
calculate scalar data unless the position of each data in the register is
aligned as in the example of summation in Fig. 4.12 (a). The sum cannot be
calculated correctly when data positions are unaligned as shown in Fig. 4.12
(b).</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=501 height=154
src="CellProgrammingTutorial.files/image065.jpg"></span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref174868697"></a><a name="_Ref174868691"></a><span lang=EN-US>Fig. </span><span
lang=EN-US>4.12: Scalar Operation using SIMD Instructions</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Scalar data can
be aligned at any position in the register if they were to be used for simple
calculations only. Nonetheless, there are several reasons for determining and
using the preferred scalar element. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>One of the
reasons resides in the design of the SPE’s instruction set, which postulates
that scalar data, such as the address information in load and store
instructions, is allocated to the preferred scalar element. This means that the
address computed by the SPE can be passed directly to these instructions only
if its data is stored in the preferred scalar element. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.5.2</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Load and Store of Scalar Data</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In this section,
scalar operations by the PPE are compared with the same by the SPE as one way
of evaluating the efficiency of using the SPE for scalar operations. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoBodyText style='text-indent:8.9pt'><span lang=EN-US>Like the
majority of currently available architectures, the PPE incorporates separate
registers for scalar data and vector data. It can also handle a variety of data
sizes, from byte to word. As shown in </span></p>

<p class=MsoBodyText style='text-indent:8.9pt'><span lang=EN-US>Fig. 4.13,
therefore, the PPE can execute scalar operations through a few simple processes
of load, calculate and store. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=506 height=97
src="CellProgrammingTutorial.files/image066.jpg"></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref173130188"><span lang=EN-US>&nbsp;</span></a></p>

<p class=MsoCaption align=center style='text-align:center'><span lang=EN-US>Fig.
4.13: Scalar Operations by PPE</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Using SIMD
instructions, the SPE can also perform scalar operations for the data allocated
in the preferred scalar element. Scalar operations by this processor, however,
cannot be done so simply as in the case of the PPE, because data must be loaded
and stored in 16-byte units, beginning on a 16-byte boundary, as explained in
Section 4.4. </span></p>

<p class=MsoNormal><span lang=EN-US>The flow of scalar operation on SPE is
shown in the following Fig.4.14.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=553 height=322
src="CellProgrammingTutorial.files/image067.jpg"></span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref173140029"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.14:
Scalar Operations by SPE</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Scalar
operations by the SPE are performed as follows.</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Input data, 16
bytes inclusive of scalar data, is loaded to the register and shifted
appropriately to the preferred scalar element. When storing the result in the
memory, the 16-bytes data inclusive of the location to store is loaded, a part
of the 16-bytes data is replaced with the calculated result, and then the whole
16-bytes data is stored, because it is impossible to store just one scalar
data.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Compared to the
PPE, it cannot be said that the SPE can handle scalar operations efficiently,
particularly when data load and store operations are involved. In particular,
special care must be taken when using codes, such as the ones listed below,
that seriously affect the performance of the program by causing frequent load
and store operations. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Reference to an element in a scalar array</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int a[16], b[16];</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>a[i] = b[i]++;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Reference to scalar data through a pointer</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int *a, *b;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>*(a + i) = *(b + i)++;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:28.5pt;text-indent:-28.5pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Reference to a member variable in a structure</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New";color:blue'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>struct foo bar;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>b = bar.a + 1;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Performance of
the SPE program can perfectly be maintained when load and store interactions
with the memory are unnecessary to be performed. Calculation of the counter
variable in the </span><b><span lang=EN-US style='font-family:Arial'>for</span></b><span
lang=EN-US> statement, for example, will cause no problem as it is performed
within the register. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.5.3</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>SIMD Intrinsics for Scalar Operations</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As in the case
of the solution program (2-1) described in Chapter 2, where the sum total of
partial sums is calculated, it is often necessary to individually manipulate
the elements of vector data. To enable such operations, the SPE provides five
intrinsics that allow data conversion between scalar and vector. For efficient
SPE programming, these intrinsics can be used according to need. Table 4.5
provides a list of intrinsics built into the SPU. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoCaption align=center style='text-align:center;page-break-after:
avoid'><a name="_Ref165122024"><span lang=EN-US>Table </span></a><span
lang=EN-US>4.5:&nbsp; List of SPU Intrinsics for Scalar Operations</span></p>

<div align=center>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=644
 style='width:483.25pt;border-collapse:collapse'>
 <tr>
  <td width=211 valign=top style='width:158.15pt;border:solid windowtext 1.0pt;
  background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>Intrinsic</span></b></p>
  </td>
  <td width=433 valign=top style='width:325.1pt;border:solid windowtext 1.0pt;
  border-left:none;background:#FFFF99;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>Description</span></b></p>
  </td>
 </tr>
 <tr style='height:41.1pt'>
  <td width=211 valign=top style='width:158.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt;height:41.1pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>d = spu_promote(a, element)</span></b></p>
  </td>
  <td width=433 valign=top style='width:325.1pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt;height:41.1pt'>
  <p class=MsoNormal align=left style='text-align:left;layout-grid-mode:char'><span
  lang=EN-US>The value of scalar <i>a </i>is promoted to a new vector
  containing <i>a </i>in the element that is specified by the <i>element </i>parameter,
  and the new vector is returned in vector <i>d</i>.</span></p>
  </td>
 </tr>
 <tr style='height:41.15pt'>
  <td width=211 valign=top style='width:158.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>spu_insert(a, b, element)</span></b></p>
  </td>
  <td width=433 valign=top style='width:325.1pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=left style='text-align:left;layout-grid-mode:char'><span
  lang=EN-US>The value of scalar <i>a </i>is inserted into the element of
  vector <i>b</i> that is specified by the <i>element</i> parameter. </span></p>
  </td>
 </tr>
 <tr style='height:41.15pt'>
  <td width=211 valign=top style='width:158.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>d = spu_extract(a, element)</span></b></p>
  </td>
  <td width=433 valign=top style='width:325.1pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=left style='text-align:left;layout-grid-mode:char'><span
  lang=EN-US>The value of the element that is specified by <i>element </i>is
  extracted from vector <i>a </i>and returned in scalar <i>d</i>. </span></p>
  </td>
 </tr>
 <tr style='height:41.15pt'>
  <td width=211 valign=top style='width:158.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>d = spu_splats(a)</span></b></p>
  </td>
  <td width=433 valign=top style='width:325.1pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=left style='text-align:left;layout-grid-mode:char'><span
  lang=EN-US>A new vector is generated by replicating the value of scalar <i>a</i>
  across all elements and returned in vector <i>d</i>.</span></p>
  </td>
 </tr>
 <tr style='height:41.15pt'>
  <td width=211 valign=top style='width:158.15pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=center style='text-align:center;layout-grid-mode:
  char'><b><span lang=EN-US>d = spu_gather(a)</span></b></p>
  </td>
  <td width=433 valign=top style='width:325.1pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt;height:41.15pt'>
  <p class=MsoNormal align=left style='text-align:left;text-autospace:none'><span
  lang=EN-US>The lowest bit (LSB) of each element of vector <i>a </i>is gathered
  in the word element 0 of a new vector, and the new vector is returned in
  vector <i>d</i>. </span></p>
  <p class=MsoNormal align=left style='text-align:left;layout-grid-mode:char'><span
  lang=EN-US>&nbsp;</span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>For more
information on the SPU intrinsics, refer to Section 2.13: Scalar Intrincis of the
C/C++ Language Extensions for Cell Broadband Engine Architecture. </span></p>

<span lang=EN-US style='font-size:10.5pt;font-family:Century'><br clear=all
style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Ref162081679"></a><a
name="_Toc188185556"></a><a name="_Toc177361271"></a><a name="_Ref171401651"></a><a
name="_Toc168979017"></a><span lang=EN-US>4.6</span><span lang=EN-US
style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Embedded SPE Program</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The PPE program
executes the SPE program by reading the SPE program image from the SPE
program’s ELF executable file. In this basic method of executing the SPE
program, which we learned before in Section 3.2, the PPE program and the SPE
program are compiled into separate ELF executable files.&nbsp; </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As explained
below, however, the SPE program can also be embedded in the ELF executable file
for the PPE program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.6.1</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>CBEA&nbsp; Embedded SPE Object Format (CESOF)</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Embedded SPE
program refers to an SPE program image embedded as data in the PPE program. As
shown in Fig. 4.15, the embedded SPE program can be produced by linking the
particular formed PPE object, which contains the SPE program, to the PPE
program. This special PPE object is called the CESOF (CBEA Embedded SPE Object
Format) object. When embedded in the PPE program, the SPE program can be
referenced from the PPE program as a handle (<i>spe_program_handle_t</i> data)
to the SPE program image.</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=166 height=224
src="CellProgrammingTutorial.files/image068.jpg"></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref173226691"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.15:&nbsp;
CESOF Object and Embedded SPE Program</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The CESOF object
can be used when it is desirable to put together in a single file the program
and library for the PPE program that utilize the SPE program. By doing so, the
PPE program can dispense with the process of opening the SPE program’s ELF
executable file. Use of the CESOF object also eliminates the problem of a lost
executable file caused by an error in specifying the file path to the SPE
program or deleting the file itself.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.6.2</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Hello World Program (Embedded SPE Program Version)</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>List (4-13)
shows the embedded SPE program for displaying “Hello world!” &nbsp;The program
is not different from the program used for the same purpose in Section 3.2. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-13): &nbsp;Hello world program (SPE
program)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFCC;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>#include &lt;stdio.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>int main(unsigned long long
  spe, unsigned long long argp, unsigned long long envp)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>{</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp;
  printf(“Hello world!¥n”);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;&nbsp;&nbsp; return
  0;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>}</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As shown in List
(4-14), the SPE program to be embedded in the PPE program is referenced from
the PPE program as an external symbol of the <i>spe_program_handle_t </i>type.&nbsp;&nbsp;
</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>List (4-14):&nbsp; Hello world program (PPE
program)</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  background:#CCFFFF;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;1 #include
  &lt;libspe2.h&gt;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;2 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99CCFF'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;3 extern
  spe_program_handle_t prog;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;4 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;5 int main(int argc,
  char **argv)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;6 {</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;
  int ret;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;
  spe_context_ptr_t spe;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;
  unsigned int entry = SPE_DEFAULT_ENTRY;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>10&nbsp;&nbsp;&nbsp;&nbsp;
  spe_stop_info_t stop;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>11 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99CCFF'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>12&nbsp;&nbsp;&nbsp;&nbsp;
  // No need to open/close SPE program image (spe_image_open() and
  spe_image_close())</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>13 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>14&nbsp;&nbsp;&nbsp;&nbsp;
  spe = spe_context_create(0, NULL);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>15&nbsp;&nbsp;&nbsp;&nbsp;
  /* ... snip ... */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char;background:#99CCFF'><span
  lang=EN-US style='font-size:9.0pt;font-family:"Courier New"'>16&nbsp;&nbsp;&nbsp;&nbsp;
  ret = spe_program_load(spe, &amp;prog);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>17&nbsp;&nbsp;&nbsp;&nbsp;
  /* ... snip ... */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>18&nbsp;&nbsp;&nbsp;&nbsp;
  ret = spe_context_run(spe, &amp;entry, 0, NULL, NULL, &amp;stop);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>19&nbsp;&nbsp;&nbsp;&nbsp;
  /* ... snip ... */</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>20&nbsp;&nbsp;&nbsp;&nbsp;
  ret = spe_context_destroy(spe);</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>21 </span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>22&nbsp;&nbsp;&nbsp;&nbsp;
  return 0;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>23 }</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 3</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Used to declare
  the handle for the SPE program image as an external variable. The name of
  this variable must be the same as the name of the external symbol for the SPE
  program image to be embedded in the CESOF object, which is generated by using
  the </span><b><span lang=EN-US style='font-family:Arial'>embedspu </span></b><span
  lang=EN-US>command explained later. </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 12</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>No need to
  call the <b>spe_image_open() </b>and the<b> spe_image_close()</b> functions,
  as the SPE program image is to be embedded in the PPE program.&nbsp; </span></p>
  </td>
 </tr>
 <tr>
  <td width=102 valign=top style='width:76.4pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Line 16</span></p>
  </td>
  <td width=592 valign=top style='width:443.7pt;padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US>Note that the
  pointer to the handle of the SPE program image must be specified in the
  second argument of the <b>spe_program_load()</b> function.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.6.3</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Creation of Embedded SPE Object</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Now then, let’s take
a look at the procedure for creating a PPE program with an embedded SPE
program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Creating SPE objects</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Creating SPE programs (linking the SPE objects)</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Creating CESOF objects</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(4)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Creating PPE objects</span></p>

<p class=MsoNormal style='margin-left:54.0pt;text-indent:-54.0pt'><span
lang=EN-US>(5)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;
</span><span lang=EN-US>Creating a PPE program </span></p>

<p class=MsoNormal style='margin-left:48.0pt;text-indent:6.0pt'><span
lang=EN-US>(linking the PPE objects and the CESOF objects)</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>These steps are
diagramed in Fig. 4.16. Steps (1) and (2) are the same as the SPE programming
we learned before. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center;page-break-after:avoid'><span
lang=EN-US><img border=0 width=481 height=314
src="CellProgrammingTutorial.files/image069.jpg"></span></p>

<p class=MsoCaption align=center style='text-align:center'><a
name="_Ref166561357"><span lang=EN-US>Fig. </span></a><span lang=EN-US>4.16:
Execution Sequence</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>A special
command called the </span><b><span lang=EN-US style='font-family:Arial'>embedspu</span></b><span
lang=EN-US> command is used in Step (3) to generate the CESOF objects from the
SPE programs. In Step (4), the PPE objects are generated from the source codes
of the PPE program, and finally in Step (5), the PPE program is created by
linking the CESOF objects and the PPE objects. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.6.4</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Compilation and Execution</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>As for the hello
world program taken as an example, Example (4-5) shows the simplest compiling
method for embedding the SPE program into the PPE program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Example (4-5): Program Compilation</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ spu-gcc &#8211;c
  hello_spe.c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  </span><span style='font-size:9.0pt;font-family:"ＭＳ 明朝"'>・・・</span><span
  lang=EN-US style='font-size:9.0pt'>Step (1)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ spu-gcc hello_spe.o &#8211;o
  hello_spe.elf&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  </span><span style='font-size:9.0pt;font-family:"ＭＳ 明朝"'>・・・</span><span
  lang=EN-US style='font-size:9.0pt'>Step (2)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ embedspu -m64 prog
  hello_spe.elf hello_embedspe.o&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-size:
  9.0pt;font-family:"ＭＳ 明朝"'>・・・</span><span lang=EN-US style='font-size:9.0pt'>Step
  (3)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ gcc &#8211;m64 &#8211;c
  hello_ppe.o&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  </span><span style='font-size:9.0pt;font-family:"ＭＳ 明朝"'>・・・</span><span
  lang=EN-US style='font-size:9.0pt'>Step (4)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>$ gcc &#8211;m64 &#8211;lspe2
  hello_ppe.o hello_embedspe.o &#8211;o hello_ppe.elf </span><span style='font-size:
  9.0pt;font-family:"ＭＳ 明朝"'>・・・</span><span lang=EN-US style='font-size:9.0pt'>Step
  (5)</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>First of all,
the ELF executable file for the SPE program is generated using the </span><b><span
lang=EN-US style='font-family:Arial'>spu-gcc</span></b><span lang=EN-US>
command (Steps (1) and (2)). Next, the CESOF object with the embedded SPE
program is generated using either the </span><b><span lang=EN-US
style='font-family:Arial'>embedspu</span></b><span lang=EN-US> command or the </span><b><span
lang=EN-US style='font-family:Arial'>ppu-embedspu</span></b><span lang=EN-US>
command (Step (3)). </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US
style='font-family:Arial'>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The </span><b><span
lang=EN-US style='font-family:Arial'>gcc</span></b><span lang=EN-US> command
can be used to generate the PPE object from the PPE program source code (Step
(4)). And finally, the ELF executable file for the PPE program is generated by
linking the CESOF object and the PPE object. </span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The PPE program
created in Step (5) is the only file required for program execution. The SPE
program created in Step (2) is no longer necessary. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Example (4-6)
shows the </span><b><span lang=EN-US style='font-family:Arial'>embedspu</span></b><span
lang=EN-US> command used to generate the CESOF object. The name of the external
symbol for the SPE program image, the name of the SPE program file to be
embedded in the PPE program and the name of the CESOF object file to be
generated are all specified to the arguments of this command. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>Example (4-6):&nbsp; </span><b><span
lang=EN-US style='font-family:Arial'>embedspu </span></b><span lang=EN-US>command</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse'>
 <tr>
  <td width=693 valign=top style='width:520.1pt;border:solid windowtext 1.0pt;
  padding:0mm 5.4pt 0mm 5.4pt'>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>embedspu {-flags ...}
  [symbol_name] [input_filename] [output_filename]</span></p>
  <p class=MsoNormal style='layout-grid-mode:char'><span lang=EN-US
  style='font-size:9.0pt;font-family:"Courier New"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>When generating
the CESOF object, the </span><b><span lang=EN-US style='font-family:Arial'>embedspu
</span></b><span lang=EN-US>command can also be passed any compiler options,
e.g. </span><b><span lang=EN-US style='font-family:Arial'>-m32</span></b><span
lang=EN-US> or </span><b><span lang=EN-US style='font-family:Arial'>-m64</span></b><span
lang=EN-US> depending on the data model. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h3 style='margin-left:82.35pt;text-indent:-82.35pt'><span lang=EN-US>4.6.5</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp; </span><span
lang=EN-US>Reference Document</span></h3>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:5.25pt;text-indent:5.25pt'><span
lang=EN-US>Additionally, the CESOF object enables shared use of global
variables between the PPE program and the SPE program. If you want to learn
more about the CESOF object, refer to Chapter 2: CBEA Embedded SPE Object
Format of the Cell Broadband Engine Linux Reference Implementation Application
Binary Interface Specification. </span></p>

<span lang=EN-US style='font-size:10.5pt;font-family:Century'><br clear=all
style='page-break-before:always'>
</span>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2 style='text-indent:-49.6pt'><a name="_Toc168979018"></a><a
name="_Toc188185557"></a><a name="_Toc177361272"></a><span lang=EN-US>4.7</span><span
lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Chapter Summary</span></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In summary, this
chapter has covered the following six topics that help you get the most from
the Cell. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:57.0pt;text-indent:-57.0pt'><span
lang=EN-US>(1)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Communication between PPE and SPE</span></p>

<p class=MsoNormal style='margin-left:57.0pt;text-indent:-57.0pt'><span
lang=EN-US>(2)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Effective Utilization of DMA Transfer</span></p>

<p class=MsoNormal style='margin-left:57.0pt;text-indent:-57.0pt'><span
lang=EN-US>(3)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Representation of Data Shared between PPE and SPE</span></p>

<p class=MsoNormal style='margin-left:57.0pt;text-indent:-57.0pt'><span
lang=EN-US>(4)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Vector Data Alignment</span></p>

<p class=MsoNormal style='margin-left:57.0pt;text-indent:-57.0pt'><span
lang=EN-US>(5)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Scalar Operations on SPE</span></p>

<p class=MsoNormal style='margin-left:57.0pt;text-indent:-57.0pt'><span
lang=EN-US>(6)</span><span lang=EN-US style='font-size:7.0pt;font-family:"Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US>Embedded SPE Program</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Major Points of
Discussion in Section 4.1: Communication between PPE and SPE</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>In this section,
we learned that the SPE’s MFC provides various means of communication between
the PPE and the SPE, including mailboxes, signal notification registers, and
stop and signal instruction, in addition to DMA transfers. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Major Points of
Discussion in Section 4.2: Effective Utilization of DMA Transfer</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This section has
been presented to inform you about the precautions on the size and alignment of
the data to be DMA transferred. A programming technique called double
buffering, as well as the MFC atomic update function that enables
synchronization in programs, has also been explained. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Major Points of
Discussion in Section 4.3: Representation of Data Shared between PPE and SPE</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>This section has
been used to describe the important points to remember about data
representations when sharing data between the PPE program and the SPE program. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Major Points of
Discussion in Section 4.4: Vector Data Alignment</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Precautions on the
SIMD data alignment have been explained in this section, together with the
technique to enable loading and storing of data that is not aligned. </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Major Points of
Discussion in Section 4.5: Scalar Operations on SPE</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Efficiency of
scalar operations by the SPE has been discussed in this section. SPU intrinsics
that allow efficient scalar operations on the SPE have also been introduced.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>Major Points of
Discussion in Section 4.6: Embedded SPE Program</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>The procedure
for embedding the SPE program into the PPE program has been described, with the
focus on the advantages of using the CESOF object.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:10.5pt'><span lang=EN-US>We hope you are
now quite familiar with Cell programming. We also hope that you go on learning
more on the foundation of knowledge you gained through this tutorial.</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
